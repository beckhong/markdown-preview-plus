"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const path = require("path");
const fs = require("fs");
const util_1 = require("../util");
const user_styles_1 = require("./user-styles");
function editorForId(editorId) {
    for (const editor of atom.workspace.getTextEditors()) {
        if (editor.id === editorId) {
            return editor;
        }
    }
    return undefined;
}
exports.editorForId = editorForId;
let getStylesOverride = undefined;
function __setGetStylesOverride(f) {
    getStylesOverride = f;
}
exports.__setGetStylesOverride = __setGetStylesOverride;
function* getStyles(context) {
    const elements = atom.styles.getStyleElements();
    for (const element of elements) {
        if (context === undefined || element.getAttribute('context') === context) {
            yield element.innerText;
        }
    }
}
function getClientStyle(file) {
    return atom.themes.loadStylesheet(path.join(__dirname, '..', '..', 'styles-client', `${file}.less`));
}
function getUserStyles() {
    const el = atom.styles.styleElementsBySourcePath[atom.styles.getUserStyleSheetPath()];
    if (!el)
        return [];
    return [el.innerText];
}
exports.getUserStyles = getUserStyles;
function getSyntaxTheme(themeName) {
    if (themeName !== '') {
        const themes = atom.themes.getLoadedThemes();
        if (themes) {
            const [theme] = themes.filter((x) => x.name === themeName);
            if (theme) {
                const stshts = theme
                    .getStylesheetPaths()
                    .map((p) => atom.themes.loadStylesheet(p));
                return processEditorStyles(stshts);
            }
        }
        atom.notifications.addWarning('Failed to load syntax theme', {
            detail: `Markdown-preview-plus couldn't find '${themeName}'`,
        });
    }
    return processEditorStyles(getStyles('atom-text-editor'));
}
function* getActivePackageStyles(packageName) {
    const pack = atom.packages.getActivePackage(packageName);
    if (!pack)
        return;
    const stylesheets = pack.getStylesheetPaths();
    for (const ss of stylesheets) {
        const element = atom.styles.styleElementsBySourcePath[ss];
        if (element)
            yield element.innerText;
    }
}
function getPreviewStyles(context) {
    if (getStylesOverride)
        return getStylesOverride(context);
    const styles = [];
    if (context === 'live') {
        const globalStyles = atom.styles.styleElementsBySourcePath['global-text-editor-styles'];
        if (globalStyles) {
            styles.push(...processWorkspaceStyles([globalStyles.innerText]));
        }
        styles.push(getClientStyle('editor-global-font'));
        const packList = util_1.atomConfig().importPackageStyles;
        if (packList.includes('*')) {
            styles.push(...processEditorStyles(getStyles()));
            styles.push(getClientStyle('patch'));
        }
        else {
            for (const pack of packList) {
                styles.push(...processEditorStyles(getActivePackageStyles(pack)));
            }
            if (packList.includes('fonts')) {
                const fontsVar = atom.styles.styleElementsBySourcePath['fonts-package-editorfont'];
                if (fontsVar)
                    styles.push(...processEditorStyles([fontsVar.innerText]));
            }
        }
    }
    styles.push(getClientStyle('generic'));
    if (context === 'live')
        styles.push(getClientStyle('display'));
    if (util_1.atomConfig().useGitHubStyle) {
        styles.push(getClientStyle('github'));
    }
    else {
        styles.push(getClientStyle('default'));
    }
    styles.push(...getSyntaxTheme(util_1.atomConfig().syntaxThemeName));
    styles.push(...processEditorStyles(getUserStyles()));
    styles.push(...user_styles_1.UserStylesManager.getStyleFiles(context).map((f) => atom.themes.loadStylesheet(f)));
    return styles;
}
exports.getPreviewStyles = getPreviewStyles;
function* processEditorStyles(styles) {
    for (const style of styles) {
        yield style.replace(/\batom-text-editor\b/g, 'pre.editor-colors');
    }
}
function* processWorkspaceStyles(styles) {
    for (const style of styles) {
        yield style.replace(/\batom-workspace\b/g, ':root');
    }
}
function getMarkdownPreviewCSSForHTMLExport() {
    const cssUrlRefExp = /url\(atom:\/\/markdown-preview-plus\/assets\/(.*)\)/;
    return getPreviewStyles('html')
        .join('\n')
        .replace(cssUrlRefExp, function (_match, assetsName, _offset, _string) {
        const assetPath = path.join(__dirname, '../../assets', assetsName);
        const originalData = fs.readFileSync(assetPath, 'binary');
        const base64Data = new Buffer(originalData, 'binary').toString('base64');
        return `url('data:image/jpeg;base64,${base64Data}')`;
    });
}
function decodeTag(token) {
    if (token.tag === 'math') {
        return 'span';
    }
    if (token.tag === 'code') {
        return 'atom-text-editor';
    }
    if (token.tag === '') {
        return null;
    }
    return token.tag;
}
function buildLineMap(tokens) {
    const lineMap = {};
    const tokenTagCount = {};
    tokenTagCount[0] = {};
    for (const token of tokens) {
        if (token.hidden)
            continue;
        if (token.map == null)
            continue;
        const tag = decodeTag(token);
        if (tag === null)
            continue;
        if (token.nesting === 1) {
            for (let line = token.map[0]; line < token.map[1]; line += 1) {
                if (lineMap[line] == null)
                    lineMap[line] = [];
                lineMap[line].push({
                    tag: tag,
                    index: tokenTagCount[token.level][tag] || 0,
                });
            }
            tokenTagCount[token.level + 1] = {};
        }
        else if (token.nesting === 0) {
            for (let line = token.map[0]; line < token.map[1]; line += 1) {
                if (lineMap[line] == null)
                    lineMap[line] = [];
                lineMap[line].push({
                    tag: tag,
                    index: tokenTagCount[token.level][tag] || 0,
                });
            }
        }
        const ttc = tokenTagCount[token.level][tag];
        tokenTagCount[token.level][tag] = ttc ? ttc + 1 : 1;
    }
    return lineMap;
}
exports.buildLineMap = buildLineMap;
function mathJaxScript(texConfig) {
    return `\
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    jax: ["input/TeX","output/HTML-CSS"],
    extensions: ["[a11y]/accessibility-menu.js"],
    'HTML-CSS': {
      availableFonts: [],
      webFont: 'TeX',
      undefinedFamily: ${JSON.stringify(util_1.atomConfig().mathConfig.undefinedFamily)},
      mtextFontInherit: true,
    },
    TeX: ${JSON.stringify(texConfig, undefined, 2)},
    showMathMenu: true
  });
</script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js"></script>`;
}
function mkHtml(title, html, renderLaTeX, texConfig) {
    let maybeMathJaxScript;
    if (renderLaTeX) {
        maybeMathJaxScript = mathJaxScript(texConfig);
    }
    else {
        maybeMathJaxScript = '';
    }
    return `\
<!DOCTYPE html>
<html data-markdown-preview-plus-context="html-export">
  <head>
    <meta charset="utf-8" />
    <title>${title}</title>${maybeMathJaxScript}
    <style>${getMarkdownPreviewCSSForHTMLExport()}</style>
${html.head.innerHTML}
  </head>
  <body>
    ${html.body.innerHTML}
  </body>
</html>
`;
}
exports.mkHtml = mkHtml;
function destroy(item) {
    const pane = atom.workspace.paneForItem(item);
    if (pane)
        util_1.handlePromise(pane.destroyItem(item));
}
exports.destroy = destroy;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXRpbC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9tYXJrZG93bi1wcmV2aWV3LXZpZXcvdXRpbC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUNBLDZCQUE0QjtBQUM1Qix5QkFBd0I7QUFFeEIsa0NBQW1EO0FBQ25ELCtDQUFpRDtBQUVqRCxTQUFnQixXQUFXLENBQUMsUUFBZ0I7SUFDMUMsS0FBSyxNQUFNLE1BQU0sSUFBSSxJQUFJLENBQUMsU0FBUyxDQUFDLGNBQWMsRUFBRSxFQUFFO1FBQ3BELElBQUksTUFBTSxDQUFDLEVBQUUsS0FBSyxRQUFRLEVBQUU7WUFDMUIsT0FBTyxNQUFNLENBQUE7U0FDZDtLQUNGO0lBQ0QsT0FBTyxTQUFTLENBQUE7QUFDbEIsQ0FBQztBQVBELGtDQU9DO0FBR0QsSUFBSSxpQkFBaUIsR0FBd0MsU0FBUyxDQUFBO0FBRXRFLFNBQWdCLHNCQUFzQixDQUFDLENBQTJCO0lBQ2hFLGlCQUFpQixHQUFHLENBQUMsQ0FBQTtBQUN2QixDQUFDO0FBRkQsd0RBRUM7QUFFRCxRQUFRLENBQUMsQ0FBQyxTQUFTLENBQUMsT0FBdUI7SUFDekMsTUFBTSxRQUFRLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxnQkFBZ0IsRUFBRSxDQUFBO0lBRS9DLEtBQUssTUFBTSxPQUFPLElBQUksUUFBUSxFQUFFO1FBQzlCLElBQUksT0FBTyxLQUFLLFNBQVMsSUFBSSxPQUFPLENBQUMsWUFBWSxDQUFDLFNBQVMsQ0FBQyxLQUFLLE9BQU8sRUFBRTtZQUN4RSxNQUFNLE9BQU8sQ0FBQyxTQUFTLENBQUE7U0FDeEI7S0FDRjtBQUNILENBQUM7QUFFRCxTQUFTLGNBQWMsQ0FBQyxJQUFZO0lBQ2xDLE9BQU8sSUFBSSxDQUFDLE1BQU0sQ0FBQyxjQUFjLENBQy9CLElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsZUFBZSxFQUFFLEdBQUcsSUFBSSxPQUFPLENBQUMsQ0FD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QUFDLGVBQWUsQ0FDeEM7OztXQUdJLElBQUksQ0FBQyxTQUFTLENBQUMsU0FBUyxFQUFFLFNBQVMsRUFBRSxDQUFDLENBQUM7Ozs7K0dBSTZELENBQUE7QUFDL0csQ0FBQztBQUVELFNBQWdCLE1BQU0sQ0FDcEIsS0FBYSxFQUNiLElBQWtCLEVBQ2xCLFdBQW9CLEVBQ3BCLFNBQW9DO0lBRXBDLElBQUksa0JBQTBCLENBQUE7SUFDOUIsSUFBSSxXQUFXLEVBQUU7UUFDZixrQkFBa0IsR0FBRyxhQUFhLENBQUMsU0FBUyxDQUFDLENBQUE7S0FDOUM7U0FBTTtRQUNMLGtCQUFrQixHQUFHLEVBQUUsQ0FBQTtLQUN4QjtJQUNELE9BQU87Ozs7O2FBS0ksS0FBSyxXQUFXLGtCQUFrQjthQUNsQyxrQ0FBa0MsRUFBRTtFQUMvQyxJQUFJLENBQUMsSUFBSyxDQUFDLFNBQVM7OztNQUdoQixJQUFJLENBQUMsSUFBSSxDQUFDLFNBQVM7OztDQUd4QixDQUFBO0FBQ0QsQ0FBQztBQTFCRCx3QkEwQkM7QUFFRCxTQUFnQixPQUFPLENBQUMsSUFBWTtJQUNsQyxNQUFNLElBQUksR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsQ0FBQTtJQUM3QyxJQUFJLElBQUk7UUFBRSxvQkFBYSxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQTtBQUNqRCxDQUFDO0FBSEQsMEJBR0MiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBUZXh0RWRpdG9yIH0gZnJvbSAnYXRvbSdcbmltcG9ydCAqIGFzIHBhdGggZnJvbSAncGF0aCdcbmltcG9ydCAqIGFzIGZzIGZyb20gJ2ZzJ1xuaW1wb3J0IFRva2VuID0gcmVxdWlyZSgnbWFya2Rvd24taXQvbGliL3Rva2VuJylcbmltcG9ydCB7IGhhbmRsZVByb21pc2UsIGF0b21Db25maWcgfSBmcm9tICcuLi91dGlsJ1xuaW1wb3J0IHsgVXNlclN0eWxlc01hbmFnZXIgfSBmcm9tICcuL3VzZXItc3R5bGVzJ1xuXG5leHBvcnQgZnVuY3Rpb24gZWRpdG9yRm9ySWQoZWRpdG9ySWQ6IG51bWJlcik6IFRleHRFZGl0b3IgfCB1bmRlZmluZWQge1xuICBmb3IgKGNvbnN0IGVkaXRvciBvZiBhdG9tLndvcmtzcGFjZS5nZXRUZXh0RWRpdG9ycygpKSB7XG4gICAgaWYgKGVkaXRvci5pZCA9PT0gZWRpdG9ySWQpIHtcbiAgICAgIHJldHVybiBlZGl0b3JcbiAgICB9XG4gIH1cbiAgcmV0dXJuIHVuZGVmaW5lZFxufVxuXG4vLyB0aGlzIHdlaXJkbmVzcyBhbGxvd3Mgb3ZlcnJpZGluZyBpbiB0ZXN0c1xubGV0IGdldFN0eWxlc092ZXJyaWRlOiB0eXBlb2YgZ2V0UHJldmlld1N0eWxlcyB8IHVuZGVmaW5lZCA9IHVuZGVmaW5lZFxuXG5leHBvcnQgZnVuY3Rpb24gX19zZXRHZXRTdHlsZXNPdmVycmlkZShmPzogdHlwZW9mIGdldFByZXZpZXdTdHlsZXMpIHtcbiAgZ2V0U3R5bGVzT3ZlcnJpZGUgPSBmXG59XG5cbmZ1bmN0aW9uKiBnZXRTdHlsZXMoY29udGV4dD86IHN0cmluZyB8IG51bGwpOiBJdGVyYWJsZUl0ZXJhdG9yPHN0cmluZz4ge1xuICBjb25zdCBlbGVtZW50cyA9IGF0b20uc3R5bGVzLmdldFN0eWxlRWxlbWVudHMoKVxuXG4gIGZvciAoY29uc3QgZWxlbWVudCBvZiBlbGVtZW50cykge1xuICAgIGlmIChjb250ZXh0ID09PSB1bmRlZmluZWQgfHwgZWxlbWVudC5nZXRBdHRyaWJ1dGUoJ2NvbnRleHQnKSA9PT0gY29udGV4dCkge1xuICAgICAgeWllbGQgZWxlbWVudC5pbm5lclRleHRcbiAgICB9XG4gIH1cbn1cblxuZnVuY3Rpb24gZ2V0Q2xpZW50U3R5bGUoZmlsZTogc3RyaW5nKTogc3RyaW5nIHtcbiAgcmV0dXJuIGF0b20udGhlbWVzLmxvYWRTdHlsZXNoZWV0KFxuICAgIHBhdGguam9pbihfX2Rpcm5hbWUsICcuLicsICcuLicsICdzdHlsZXMtY2xpZW50JywgYCR7ZmlsZX0ubGVzc2ApLFxuICApXG59XG5cbmV4cG9ydCBmdW5jdGlvbiBnZXRVc2VyU3R5bGVzKCkge1xuICBjb25zdCBlbCA9XG4gICAgYXRvbS5zdHlsZXMuc3R5bGVFbGVtZW50c0J5U291cmNlUGF0aFthdG9tLnN0eWxlcy5nZXRVc2VyU3R5bGVTaGVldFBhdGgoKV1cbiAgaWYgKCFlbCkgcmV0dXJuIFtdXG4gIHJldHVybiBbZWwuaW5uZXJUZXh0XVxufVxuXG5mdW5jdGlvbiBnZXRTeW50YXhUaGVtZSh0aGVtZU5hbWU6IHN0cmluZyk6IEl0ZXJhYmxlPHN0cmluZz4ge1xuICBpZiAodGhlbWVOYW1lICE9PSAnJykge1xuICAgIGNvbnN0IHRoZW1lcyA9IGF0b20udGhlbWVzLmdldExvYWRlZFRoZW1lcygpXG4gICAgaWYgKHRoZW1lcykge1xuICAgICAgY29uc3QgW3RoZW1lXSA9IHRoZW1lcy5maWx0ZXIoKHgpID0+IHgubmFtZSA9PT0gdGhlbWVOYW1lKVxuICAgICAgaWYgKHRoZW1lKSB7XG4gICAgICAgIGNvbnN0IHN0c2h0cyA9IHRoZW1lXG4gICAgICAgICAgLmdldFN0eWxlc2hlZXRQYXRocygpXG4gICAgICAgICAgLm1hcCgocCkgPT4gYXRvbS50aGVtZXMubG9hZFN0eWxlc2hlZXQocCkpXG4gICAgICAgIHJldHVybiBwcm9jZXNzRWRpdG9yU3R5bGVzKHN0c2h0cylcbiAgICAgIH1cbiAgICB9XG4gICAgYXRvbS5ub3RpZmljYXRpb25zLmFkZFdhcm5pbmcoJ0ZhaWxlZCB0byBsb2FkIHN5bnRheCB0aGVtZScsIHtcbiAgICAgIGRldGFpbDogYE1hcmtkb3duLXByZXZpZXctcGx1cyBjb3VsZG4ndCBmaW5kICcke3RoZW1lTmFtZX0nYCxcbiAgICB9KVxuICB9XG4gIC8vIGRlZmF1bHRcbiAgcmV0dXJuIHByb2Nlc3NFZGl0b3JTdHlsZXMoZ2V0U3R5bGVzKCdhdG9tLXRleHQtZWRpdG9yJykpXG59XG5cbmZ1bmN0aW9uKiBnZXRBY3RpdmVQYWNrYWdlU3R5bGVzKFxuICBwYWNrYWdlTmFtZTogc3RyaW5nLFxuKTogSXRlcmFibGVJdGVyYXRvcjxzdHJpbmc+IHtcbiAgY29uc3QgcGFjayA9IGF0b20ucGFja2FnZXMuZ2V0QWN0aXZlUGFja2FnZShwYWNrYWdlTmFtZSlcbiAgaWYgKCFwYWNrKSByZXR1cm5cbiAgY29uc3Qgc3R5bGVzaGVldHMgPSBwYWNrLmdldFN0eWxlc2hlZXRQYXRocygpXG4gIGZvciAoY29uc3Qgc3Mgb2Ygc3R5bGVzaGVldHMpIHtcbiAgICBjb25zdCBlbGVtZW50ID0gYXRvbS5zdHlsZXMuc3R5bGVFbGVtZW50c0J5U291cmNlUGF0aFtzc11cbiAgICBpZiAoZWxlbWVudCkgeWllbGQgZWxlbWVudC5pbm5lclRleHRcbiAgfVxufVxuXG5leHBvcnQgZnVuY3Rpb24gZ2V0UHJldmlld1N0eWxlcyhcbiAgY29udGV4dDogJ3BkZicgfCAnY29weScgfCAnaHRtbCcgfCAnbGl2ZScsXG4pOiBzdHJpbmdbXSB7XG4gIGlmIChnZXRTdHlsZXNPdmVycmlkZSkgcmV0dXJuIGdldFN0eWxlc092ZXJyaWRlKGNvbnRleHQpXG4gIGNvbnN0IHN0eWxlcyA9IFtdXG4gIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTp0b3RhbGl0eS1jaGVja1xuICBpZiAoY29udGV4dCA9PT0gJ2xpdmUnKSB7XG4gICAgLy8gZ2xvYmFsIGVkaXRvciBzdHlsZXNcbiAgICBjb25zdCBnbG9iYWxTdHlsZXMgPVxuICAgICAgYXRvbS5zdHlsZXMuc3R5bGVFbGVtZW50c0J5U291cmNlUGF0aFsnZ2xvYmFsLXRleHQtZWRpdG9yLXN0eWxlcyddXG4gICAgaWYgKGdsb2JhbFN0eWxlcykge1xuICAgICAgc3R5bGVzLnB1c2goLi4ucHJvY2Vzc1dvcmtzcGFjZVN0eWxlcyhbZ2xvYmFsU3R5bGVzLmlubmVyVGV4dF0pKVxuICAgIH1cbiAgICBzdHlsZXMucHVzaChnZXRDbGllbnRTdHlsZSgnZWRpdG9yLWdsb2JhbC1mb250JykpXG4gICAgLy8gcGFja2FnZSBzdHlsZXNcbiAgICBjb25zdCBwYWNrTGlzdCA9IGF0b21Db25maWcoKS5pbXBvcnRQYWNrYWdlU3R5bGVzXG4gICAgaWYgKHBhY2tMaXN0LmluY2x1ZGVzKCcqJykpIHtcbiAgICAgIHN0eWxlcy5wdXNoKC4uLnByb2Nlc3NFZGl0b3JTdHlsZXMoZ2V0U3R5bGVzKCkpKVxuICAgICAgc3R5bGVzLnB1c2goZ2V0Q2xpZW50U3R5bGUoJ3BhdGNoJykpXG4gICAgfSBlbHNlIHtcbiAgICAgIGZvciAoY29uc3QgcGFjayBvZiBwYWNrTGlzdCkge1xuICAgICAgICBzdHlsZXMucHVzaCguLi5wcm9jZXNzRWRpdG9yU3R5bGVzKGdldEFjdGl2ZVBhY2thZ2VTdHlsZXMocGFjaykpKVxuICAgICAgfVxuICAgICAgLy8gZXhwbGljaXQgY29tcGF0aWJpbGl0eSB3aXRoIHRoZSBmb250cyBwYWNrYWdlXG4gICAgICBpZiAocGFja0xpc3QuaW5jbHVkZXMoJ2ZvbnRzJykpIHtcbiAgICAgICAgY29uc3QgZm9udHNWYXIgPVxuICAgICAgICAgIGF0b20uc3R5bGVzLnN0eWxlRWxlbWVudHNCeVNvdXJjZVBhdGhbJ2ZvbnRzLXBhY2thZ2UtZWRpdG9yZm9udCddXG4gICAgICAgIGlmIChmb250c1Zhcikgc3R5bGVzLnB1c2goLi4ucHJvY2Vzc0VkaXRvclN0eWxlcyhbZm9udHNWYXIuaW5uZXJUZXh0XSkpXG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgc3R5bGVzLnB1c2goZ2V0Q2xpZW50U3R5bGUoJ2dlbmVyaWMnKSlcbiAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOnRvdGFsaXR5LWNoZWNrXG4gIGlmIChjb250ZXh0ID09PSAnbGl2ZScpIHN0eWxlcy5wdXNoKGdldENsaWVudFN0eWxlKCdkaXNwbGF5JykpXG4gIGlmIChhdG9tQ29uZmlnKCkudXNlR2l0SHViU3R5bGUpIHtcbiAgICBzdHlsZXMucHVzaChnZXRDbGllbnRTdHlsZSgnZ2l0aHViJykpXG4gIH0gZWxzZSB7XG4gICAgc3R5bGVzLnB1c2goZ2V0Q2xpZW50U3R5bGUoJ2RlZmF1bHQnKSlcbiAgfVxuICBzdHlsZXMucHVzaCguLi5nZXRTeW50YXhUaGVtZShhdG9tQ29uZmlnKCkuc3ludGF4VGhlbWVOYW1lKSlcbiAgc3R5bGVzLnB1c2goLi4ucHJvY2Vzc0VkaXRvclN0eWxlcyhnZXRVc2VyU3R5bGVzKCkpKVxuICBzdHlsZXMucHVzaChcbiAgICAuLi5Vc2VyU3R5bGVzTWFuYWdlci5nZXRTdHlsZUZpbGVzKGNvbnRleHQpLm1hcCgoZikgPT5cbiAgICAgIGF0b20udGhlbWVzLmxvYWRTdHlsZXNoZWV0KGYpLFxuICAgICksXG4gIClcbiAgcmV0dXJuIHN0eWxlc1xufVxuXG5mdW5jdGlvbiogcHJvY2Vzc0VkaXRvclN0eWxlcyhzdHlsZXM6IEl0ZXJhYmxlPHN0cmluZz4pIHtcbiAgZm9yIChjb25zdCBzdHlsZSBvZiBzdHlsZXMpIHtcbiAgICB5aWVsZCBzdHlsZS5yZXBsYWNlKC9cXGJhdG9tLXRleHQtZWRpdG9yXFxiL2csICdwcmUuZWRpdG9yLWNvbG9ycycpXG4gIH1cbn1cblxuZnVuY3Rpb24qIHByb2Nlc3NXb3Jrc3BhY2VTdHlsZXMoc3R5bGVzOiBJdGVyYWJsZTxzdHJpbmc+KSB7XG4gIGZvciAoY29uc3Qgc3R5bGUgb2Ygc3R5bGVzKSB7XG4gICAgeWllbGQgc3R5bGUucmVwbGFjZSgvXFxiYXRvbS13b3Jrc3BhY2VcXGIvZywgJzpyb290JylcbiAgfVxufVxuXG5mdW5jdGlvbiBnZXRNYXJrZG93blByZXZpZXdDU1NGb3JIVE1MRXhwb3J0KCkge1xuICBjb25zdCBjc3NVcmxSZWZFeHAgPSAvdXJsXFwoYXRvbTpcXC9cXC9tYXJrZG93bi1wcmV2aWV3LXBsdXNcXC9hc3NldHNcXC8oLiopXFwpL1xuXG4gIHJldHVybiBnZXRQcmV2aWV3U3R5bGVzKCdodG1sJylcbiAgICAuam9pbignXFxuJylcbiAgICAucmVwbGFjZShjc3NVcmxSZWZFeHAsIGZ1bmN0aW9uKFxuICAgICAgX21hdGNoLFxuICAgICAgYXNzZXRzTmFtZTogc3RyaW5nLFxuICAgICAgX29mZnNldCxcbiAgICAgIF9zdHJpbmcsXG4gICAgKSB7XG4gICAgICAvLyBiYXNlNjQgZW5jb2RlIGFzc2V0c1xuICAgICAgY29uc3QgYXNzZXRQYXRoID0gcGF0aC5qb2luKF9fZGlybmFtZSwgJy4uLy4uL2Fzc2V0cycsIGFzc2V0c05hbWUpXG4gICAgICBjb25zdCBvcmlnaW5hbERhdGEgPSBmcy5yZWFkRmlsZVN5bmMoYXNzZXRQYXRoLCAnYmluYXJ5JylcbiAgICAgIGNvbnN0IGJhc2U2NERhdGEgPSBuZXcgQnVmZmVyKG9yaWdpbmFsRGF0YSwgJ2JpbmFyeScpLnRvU3RyaW5nKCdiYXNlNjQnKVxuICAgICAgcmV0dXJuIGB1cmwoJ2RhdGE6aW1hZ2UvanBlZztiYXNlNjQsJHtiYXNlNjREYXRhfScpYFxuICAgIH0pXG59XG5cbi8vXG4vLyBEZWNvZGUgdGFncyB1c2VkIGJ5IG1hcmtkb3duLWl0XG4vL1xuLy8gQHBhcmFtIHttYXJrZG93bi1pdC5Ub2tlbn0gdG9rZW4gRGVjb2RlIHRoZSB0YWcgb2YgdG9rZW4uXG4vLyBAcmV0dXJuIHtzdHJpbmd8bnVsbH0gRGVjb2RlZCB0YWcgb3IgYG51bGxgIGlmIHRoZSB0b2tlbiBoYXMgbm8gdGFnLlxuLy9cbmZ1bmN0aW9uIGRlY29kZVRhZyh0b2tlbjogVG9rZW4pOiBzdHJpbmcgfCBudWxsIHtcbiAgaWYgKHRva2VuLnRhZyA9PT0gJ21hdGgnKSB7XG4gICAgcmV0dXJuICdzcGFuJ1xuICB9XG4gIGlmICh0b2tlbi50YWcgPT09ICdjb2RlJykge1xuICAgIHJldHVybiAnYXRvbS10ZXh0LWVkaXRvcidcbiAgfVxuICBpZiAodG9rZW4udGFnID09PSAnJykge1xuICAgIHJldHVybiBudWxsXG4gIH1cbiAgcmV0dXJuIHRva2VuLnRhZ1xufVxuXG4vL1xuLy8gRGV0ZXJtaW5lIHBhdGggdG8gYSB0YXJnZXQgdG9rZW4uXG4vL1xuLy8gQHBhcmFtIHsobWFya2Rvd24taXQuVG9rZW4pW119IHRva2VucyBBcnJheSBvZiB0b2tlbnMgYXMgcmV0dXJuZWQgYnlcbi8vICAgYG1hcmtkb3duLWl0LnBhcnNlKClgLlxuLy8gQHBhcmFtIHtudW1iZXJ9IGxpbmUgTGluZSByZXByZXNlbnRpbmcgdGhlIHRhcmdldCB0b2tlbi5cbi8vIEByZXR1cm4geyh0YWc6IDx0YWc+LCBpbmRleDogPGluZGV4PilbXX0gQXJyYXkgcmVwcmVzZW50aW5nIGEgcGF0aCB0byB0aGVcbi8vICAgdGFyZ2V0IHRva2VuLiBUaGUgcm9vdCB0b2tlbiBpcyByZXByZXNlbnRlZCBieSB0aGUgZmlyc3QgZWxlbWVudCBpbiB0aGVcbi8vICAgYXJyYXkgYW5kIHRoZSB0YXJnZXQgdG9rZW4gYnkgdGhlIGxhc3QgZWxtZW50LiBFYWNoIGVsZW1lbnQgY29uc2lzdHMgb2YgYVxuLy8gICBgdGFnYCBhbmQgYGluZGV4YCByZXByZXNlbnRpbmcgaXRzIGluZGV4IGFtb25nc3QgaXRzIHNpYmxpbmcgdG9rZW5zIGluXG4vLyAgIGB0b2tlbnNgIG9mIHRoZSBzYW1lIGB0YWdgLiBgbGluZWAgd2lsbCBsaWUgYmV0d2VlbiB0aGUgcHJvcGVydGllc1xuLy8gICBgbWFwWzBdYCBhbmQgYG1hcFsxXWAgb2YgdGhlIHRhcmdldCB0b2tlbi5cbi8vXG5leHBvcnQgZnVuY3Rpb24gYnVpbGRMaW5lTWFwKHRva2VuczogUmVhZG9ubHlBcnJheTxSZWFkb25seTxUb2tlbj4+KSB7XG4gIGNvbnN0IGxpbmVNYXA6IHsgW2xpbmU6IG51bWJlcl06IEFycmF5PHsgdGFnOiBzdHJpbmc7IGluZGV4OiBudW1iZXIgfT4gfSA9IHt9XG4gIGNvbnN0IHRva2VuVGFnQ291bnQ6IHsgW2xpbmU6IG51bWJlcl06IHsgW3RhZzogc3RyaW5nXTogbnVtYmVyIH0gfSA9IHt9XG4gIHRva2VuVGFnQ291bnRbMF0gPSB7fVxuXG4gIGZvciAoY29uc3QgdG9rZW4gb2YgdG9rZW5zKSB7XG4gICAgaWYgKHRva2VuLmhpZGRlbikgY29udGludWVcbiAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6c3RyaWN0LXR5cGUtcHJlZGljYXRlcyAvLyBUT0RPOiBjb21wbGFpbiBvbiBEVFxuICAgIGlmICh0b2tlbi5tYXAgPT0gbnVsbCkgY29udGludWVcblxuICAgIGNvbnN0IHRhZyA9IGRlY29kZVRhZyh0b2tlbilcbiAgICBpZiAodGFnID09PSBudWxsKSBjb250aW51ZVxuXG4gICAgaWYgKHRva2VuLm5lc3RpbmcgPT09IDEpIHtcbiAgICAgIC8vIG9wZW5pbmcgdGFnXG4gICAgICBmb3IgKGxldCBsaW5lID0gdG9rZW4ubWFwWzBdOyBsaW5lIDwgdG9rZW4ubWFwWzFdOyBsaW5lICs9IDEpIHtcbiAgICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOnN0cmljdC10eXBlLXByZWRpY2F0ZXNcbiAgICAgICAgaWYgKGxpbmVNYXBbbGluZV0gPT0gbnVsbCkgbGluZU1hcFtsaW5lXSA9IFtdXG4gICAgICAgIGxpbmVNYXBbbGluZV0ucHVzaCh7XG4gICAgICAgICAgdGFnOiB0YWcsXG4gICAgICAgICAgaW5kZXg6IHRva2VuVGFnQ291bnRbdG9rZW4ubGV2ZWxdW3RhZ10gfHwgMCxcbiAgICAgICAgfSlcbiAgICAgIH1cbiAgICAgIHRva2VuVGFnQ291bnRbdG9rZW4ubGV2ZWwgKyAxXSA9IHt9XG4gICAgfSBlbHNlIGlmICh0b2tlbi5uZXN0aW5nID09PSAwKSB7XG4gICAgICAvLyBzZWxmLWNsb3NpbmcgdGFnXG4gICAgICBmb3IgKGxldCBsaW5lID0gdG9rZW4ubWFwWzBdOyBsaW5lIDwgdG9rZW4ubWFwWzFdOyBsaW5lICs9IDEpIHtcbiAgICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOnN0cmljdC10eXBlLXByZWRpY2F0ZXNcbiAgICAgICAgaWYgKGxpbmVNYXBbbGluZV0gPT0gbnVsbCkgbGluZU1hcFtsaW5lXSA9IFtdXG4gICAgICAgIGxpbmVNYXBbbGluZV0ucHVzaCh7XG4gICAgICAgICAgdGFnOiB0YWcsXG4gICAgICAgICAgaW5kZXg6IHRva2VuVGFnQ291bnRbdG9rZW4ubGV2ZWxdW3RhZ10gfHwgMCxcbiAgICAgICAgfSlcbiAgICAgIH1cbiAgICB9XG4gICAgY29uc3QgdHRjID0gdG9rZW5UYWdDb3VudFt0b2tlbi5sZXZlbF1bdGFnXVxuICAgIHRva2VuVGFnQ291bnRbdG9rZW4ubGV2ZWxdW3RhZ10gPSB0dGMgPyB0dGMgKyAxIDogMVxuICB9XG5cbiAgcmV0dXJuIGxpbmVNYXBcbn1cblxuZnVuY3Rpb24gbWF0aEpheFNjcmlwdCh0ZXhDb25maWc6IE1hdGhKYXguVGVYSW5wdXRQcm9jZXNzb3IpIHtcbiAgcmV0dXJuIGBcXFxuPHNjcmlwdCB0eXBlPVwidGV4dC94LW1hdGhqYXgtY29uZmlnXCI+XG4gIE1hdGhKYXguSHViLkNvbmZpZyh7XG4gICAgamF4OiBbXCJpbnB1dC9UZVhcIixcIm91dHB1dC9IVE1MLUNTU1wiXSxcbiAgICBleHRlbnNpb25zOiBbXCJbYTExeV0vYWNjZXNzaWJpbGl0eS1tZW51LmpzXCJdLFxuICAgICdIVE1MLUNTUyc6IHtcbiAgICAgIGF2YWlsYWJsZUZvbnRzOiBbXSxcbiAgICAgIHdlYkZvbnQ6ICdUZVgnLFxuICAgICAgdW5kZWZpbmVkRmFtaWx5OiAke0pTT04uc3RyaW5naWZ5KFxuICAgICAgICBhdG9tQ29uZmlnKCkubWF0aENvbmZpZy51bmRlZmluZWRGYW1pbHksXG4gICAgICApfSxcbiAgICAgIG10ZXh0Rm9udEluaGVyaXQ6IHRydWUsXG4gICAgfSxcbiAgICBUZVg6ICR7SlNPTi5zdHJpbmdpZnkodGV4Q29uZmlnLCB1bmRlZmluZWQsIDIpfSxcbiAgICBzaG93TWF0aE1lbnU6IHRydWVcbiAgfSk7XG48L3NjcmlwdD5cbjxzY3JpcHQgdHlwZT1cInRleHQvamF2YXNjcmlwdFwiIHNyYz1cImh0dHBzOi8vY2RuanMuY2xvdWRmbGFyZS5jb20vYWpheC9saWJzL21hdGhqYXgvMi43LjQvTWF0aEpheC5qc1wiPjwvc2NyaXB0PmBcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIG1rSHRtbChcbiAgdGl0bGU6IHN0cmluZyxcbiAgaHRtbDogSFRNTERvY3VtZW50LFxuICByZW5kZXJMYVRlWDogYm9vbGVhbixcbiAgdGV4Q29uZmlnOiBNYXRoSmF4LlRlWElucHV0UHJvY2Vzc29yLFxuKSB7XG4gIGxldCBtYXliZU1hdGhKYXhTY3JpcHQ6IHN0cmluZ1xuICBpZiAocmVuZGVyTGFUZVgpIHtcbiAgICBtYXliZU1hdGhKYXhTY3JpcHQgPSBtYXRoSmF4U2NyaXB0KHRleENvbmZpZylcbiAgfSBlbHNlIHtcbiAgICBtYXliZU1hdGhKYXhTY3JpcHQgPSAnJ1xuICB9XG4gIHJldHVybiBgXFxcbjwhRE9DVFlQRSBodG1sPlxuPGh0bWwgZGF0YS1tYXJrZG93bi1wcmV2aWV3LXBsdXMtY29udGV4dD1cImh0bWwtZXhwb3J0XCI+XG4gIDxoZWFkPlxuICAgIDxtZXRhIGNoYXJzZXQ9XCJ1dGYtOFwiIC8+XG4gICAgPHRpdGxlPiR7dGl0bGV9PC90aXRsZT4ke21heWJlTWF0aEpheFNjcmlwdH1cbiAgICA8c3R5bGU+JHtnZXRNYXJrZG93blByZXZpZXdDU1NGb3JIVE1MRXhwb3J0KCl9PC9zdHlsZT5cbiR7aHRtbC5oZWFkIS5pbm5lckhUTUx9XG4gIDwvaGVhZD5cbiAgPGJvZHk+XG4gICAgJHtodG1sLmJvZHkuaW5uZXJIVE1MfVxuICA8L2JvZHk+XG48L2h0bWw+XG5gIC8vIEVuc3VyZSB0cmFpbGluZyBuZXdsaW5lXG59XG5cbmV4cG9ydCBmdW5jdGlvbiBkZXN0cm95KGl0ZW06IG9iamVjdCkge1xuICBjb25zdCBwYW5lID0gYXRvbS53b3Jrc3BhY2UucGFuZUZvckl0ZW0oaXRlbSlcbiAgaWYgKHBhbmUpIGhhbmRsZVByb21pc2UocGFuZS5kZXN0cm95SXRlbShpdGVtKSlcbn1cbiJdfQ==